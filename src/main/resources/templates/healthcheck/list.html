<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:http="http://www.w3.org/1999/xhtml"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4">
<!-- th:fragment 定义需要引入的代码块，该div包含的内容即为引用的公共内容 -->
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="copyright" content="All Rights Reserved, Copyright (C) 2013, , Ltd."/>
    <title></title>
    <link rel="stylesheet" type="text/css" href="/admin/easyui/easyui/1.7.0/themes/default/easyui.css"/>
    <link rel="stylesheet" type="text/css" href="/admin/easyui/css/wu.css"/>
    <link rel="stylesheet" type="text/css" href="/admin/easyui/css/icon.css"/>
    <script type="text/javascript" src="/admin/easyui/js/jquery-1.8.0.min.js"></script>
    <script type="text/javascript" src="/admin/easyui/easyui/1.3.4/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="/admin/easyui/easyui/1.3.4/locale/easyui-lang-zh_CN.js"></script>

<body class="easyui-layout">


<div class="easyui-layout" data-options="fit:true">
    <!-- Begin of toolbar -->
    <div id="wu-toolbar">
        <div class="wu-toolbar-button">
            <!--引入菜单页面-->
            <div th:replace="common/menus :: menus"></div>
        </div>
        <div class="wu-toolbar-search">
            <label>用户名:</label><input id="search-name" class="wu-text" style="width:100px">
            <a href="#" id="search-btn" class="easyui-linkbutton" iconCls="icon-search">搜索</a>
            <input type="hidden" id="name" > <input type="hidden" id="userinfoId" >
        </div>
    </div>
    <!-- End of toolbar -->
    <table id="data-datagrid" class="easyui-datagrid" toolbar="#wu-toolbar"></table>
</div>

<!-- 引入 体检表格-->
<div id="healcheck-dialog" title='该用户所有体检' class='easyui-dialog' data-options="closed:true"
     style="width:900px;height:600px;overflow:scroll; padding:0px; ">
    <table id="healcheckdata-datagrid" class="easyui-datagrid" ></table>

</div>


<!-- 引入 体检表格-->
<div id="add-dialog" title='添加体检' class='easyui-dialog' data-options="closed:true"
         style="width:900px;height:600px;overflow:scroll; padding:0px; ">
    <form id="add-form1" class="easyui-form" method="post" data-options="novalidate:true">
    <div th:replace="common/healthcheck :: healthcheck"></div>
    </form>
</div>


<!--&lt;!&ndash;</div>&ndash;&gt;-->
<!--&lt;!&ndash; 修改窗口 &ndash;&gt;-->
<!--<div id="edit-dialog" class="easyui-dialog" data-options="closed:true,iconCls:'icon-save'"-->
     <!--style="width:900px;height:600px;overflow:scroll; padding:0px; ">-->
    <!--<form id="edit-form" method="post">-->
        <!--<div th:replace="common/healthcheck :: healthcheck"></div>-->
    <!--</form>-->
<!--</div>-->

<!--引入叫本页面<%@include file="../common/footer.jsp"%>-->
<div th:replace="common/footer :: myfooter"></div>


<!-- End of easyui-dialog -->
<script type="text/javascript" th:inline="none">

    /**
     *  添加记录
     */
    function add() {
        var validate = $("#add-form1").form("validate");
        if (!validate) {
            $.messager.alert("消息提醒", "请检查你输入的数据!", "warning");
            return;
        }
        var data = $("#add-form1").serialize();
        console.log(data);
        $.ajax({
            url: 'add',
            dataType: 'json',
            type: 'post',
            data: data,
            success: function (data) {
                if (data.type == 'success') {
                    $.messager.alert('信息提示', data.msg, 'info');
                    $('#add-dialog').dialog('close');
                    $('#data-datagrid').datagrid('reload');
                } else {
                    $.messager.alert('信息提示', data.msg, 'warning');
                }
            }
        });
    }

    /**
     * Name 修改记录
     */
    function edit() {
        var validate = $("#edit-form").form("validate");
        if (!validate) {
            $.messager.alert("消息提醒", "请检查你输入的数据!", "warning");
            return;
        }
        var data = $("#edit-form").serialize();
        $.ajax({
            url: 'edit',
            dataType: 'json',
            type: 'post',
            data: data,
            success: function (data) {
                // 修改方法加载的数据
                if (data.type == 'success') {
                    $.messager.alert('信息提示', data.msg, 'warning');
                    $('#edit-dialog').dialog('close');
                    $('#healcheck-dialog').datagrid('reload');
                } else {
                    $.messager.alert('信息提示', data.msg, 'warning');
                }
            }
        });
    }

    /**
     * 删除记录
     */
    function remove() {
        $.messager.confirm('信息提示', '确定要删除该记录？', function (result) {
            if (result) {
                var item = $('#data-datagrid').datagrid('getSelections');
                if (item == null || item.length == 0) {
                    $.messager.alert('信息提示', '请选择要删除的数据！', 'info');
                    return;
                }
                var ids = '';
                for (var i = 0; i < item.length; i++) {
                    ids += item[i].userId + ',';
                }
                $.ajax({
                    url: 'delete',
                    dataType: 'json',
                    type: 'post',
                    data: {ids: ids},
                    success: function (data) {
                        if (data.type == 'success') {
                            $.messager.alert('信息提示', '删除成功！', 'info');
                            $('#data-datagrid').datagrid('reload');
                        } else {
                            $.messager.alert('信息提示', data.msg, 'warning');
                        }
                    }
                });
            }
        });
    }

    /**
     * Name 打开添加窗口
     */
    function openAdd() {
        var editname=$("#name").val();
        var userinfoId=$("#userinfoId").val();
        $('#add-form').form('reset');
        $('#add-dialog').dialog({
            closed: false,
            modal: true,
            top:0,
            title: "添加用户信息",
            buttons: [{
                text: '添加',
                iconCls: 'icon-ok',
                handler: add,
            }, {
                text: '取消',
                iconCls: 'icon-cancel',
                handler: function () {
                    $('#add-dialog').dialog('close');
                }
            }],
            onBeforeOpen: function () {
                $("input[name='recordName']").val(editname);
                $("input[name='userinfoId']").val(userinfoId);
                //$("#add-form input").val('');
            }
        });
    }



    /**
     * 打开修改窗口
     */
    function openEdit() {
        var editname=$("#name").val();
        var userinfoId=$("#userinfoId").val();
        var item = $('#healcheckdata-datagrid').datagrid('getSelections');
        if (item == null || item.length == 0) {
            $.messager.alert('信息提示', '请选择要修改的数据！', 'info');
            return;
        }
        if (item.length > 1) {
            $.messager.alert('信息提示', '请选择一条数据进行修改！', 'info');
            return;
        }
        item = item[0];
        $('#add-dialog').dialog({
            closed: false,
            modal: true,
            title: "修改用户信息",
            buttons: [{
                text: '提交',
                iconCls: 'icon-ok',
                handler: edit
            },{
                text: '取消',
                iconCls: 'icon-cancel',
                handler: function () {
                    $('#add-dialog').dialog('close');
                }}],
            onBeforeOpen: function () {
                $.ajax({
                    url:'findById',
                    dataType:'json',
                    type:'post',
                    data:{id:item.healthcheckId},
                    success:function(data){
                        if(data.type == 'success'){
                            $('#add-form1').form('load',data.datainfo);
                            $("input[name='recordName']").val(editname);
                            $("input[name='userinfoId']").val(userinfoId);
                        }else{
                            $.messager.alert('信息提示',data.msg,'warning');
                        }
                    }
                });

            }
        });
    }


    //搜索按钮监听
    $("#search-btn").click(function () {
        var roleId = $("#search-role").combobox('getValue');
        var sex = $("#search-sex").combobox('getValue');
        var option = {username: $("#search-name").val()};
        if (roleId != -1) {
            option.roleId = roleId;
        }
        if (sex != -1) {
            option.sex = sex;
        }
        $('#data-datagrid').datagrid('reload', option);
    });



    function add0(m){return m<10?'0'+m:m }
    function format(shijianchuo){
        //shijianchuo是整数，否则要parseInt转换
        var time = new Date(shijianchuo);
        var y = time.getFullYear();
        var m = time.getMonth()+1;
        var d = time.getDate();
        var h = time.getHours();
        var mm = time.getMinutes();
        var s = time.getSeconds();
        return y+'-'+add0(m)+'-'+add0(d)+' '+add0(h)+':'+add0(mm)+':'+add0(s);
    }
    /**
     * 载入数据
     */
    $('#data-datagrid').datagrid({
        url: 'list',
        rownumbers: true,
        singleSelect: true,
        pageSize: 20,
        pagination: true,
        multiSort: true,
        fitColumns: true,
        idField: 'userId',
        treeField: 'name',
        fit: true,
        onDblClickRow:function(rowIndex, rowData){
            $("#name").val(rowData.recordName);
            $("#userinfoId").val(rowData.userId);
            // 双击数据，打开表格
            $("#healcheck-dialog").dialog({
                closed: false,
                modal: true,
                top:0,
                title: "该用户所有体检信息",
                buttons: [{
                    text: '添加',
                    iconCls: 'icon-ok',
                    handler: openAdd,
                },{
                    text: '修改',
                    iconCls: 'icon-ok',
                    handler: openEdit,
                },{
                    text: '删除',
                    iconCls: 'icon-ok',
                    handler: remove,
                },{
                    text: '取消',
                    iconCls: 'icon-cancel',
                    handler: function () {
                        $('#healcheck-dialog').dialog('close');
                    }
                }],
                onBeforeOpen: function () {
                    $('#healcheckdata-datagrid').datagrid({
                        url: 'list2?userinfoId='+rowData.userId,
                        rownumbers: true,
                        singleSelect: true,
                        pageSize: 20,
                        pagination: true,
                        multiSort: true,
                        fitColumns: true,
                        idField: 'healthcheckId',
                        treeField: 'name',
                        fit: true,
                        columns: [[
                            {field: 'chk', checkbox: true},
                            {field: 'healthcheckId', title: '档案编号', width: 100,hidden:'true'},
                            {field: 'healthcheckDate', title: '体检日期', width: 100,formatter:function(value,row,index){
                                    return format(value);
                                }},
                            {field: 'healthcheckDoctor', title: '责任医生', width: 100, formatter: function (value, row, index) {
                                    switch (value) {
                                        case 3: {
                                            return '曾子墨';
                                        }
                                        case 1: {
                                            return '金峰';
                                        }
                                        case 2: {
                                            return '张承天';
                                        }
                                    }
                                    return value;
                                }},
                        ]]});
                }

        });
        },
        columns: [[
            {field: 'chk', checkbox: true},
            {field: 'userId', title: '档案编号', width: 100},
            {field: 'userPapernumber', title: '纸质编号', width: 100},
            {field: 'recordName', title: '姓名', width: 100, sortable: true},
            {
                field: 'userNamtion', title: '名族', width: 100, formatter: function (value, row, index) {
                    switch (value) {
                        case 0: {
                            return '未知';
                        }
                        case 1: {
                            return '汉族';
                        }
                        case 2: {
                            return '少数民族';
                        }
                    }
                    return value;
                }
            },
            {
                field: 'userSex', title: '性别', width: 100, formatter: function (value, row, index) {
                    switch (value) {
                        case 3: {
                            return '未知';
                        }
                        case 1: {
                            return '男';
                        }
                        case 2: {
                            return '女';
                        }
                    }
                    return value;
                }
            },
            {field: 'recordPlaceadress', title: '户籍地址', width: 100},
            {
                field: 'userPemanent', title: '户籍方式', width: 100, formatter: function (value, row, index) {
                    switch (value) {
                        case 3: {
                            return '未知';
                        }
                        case 1: {
                            return '户籍';
                        }
                        case 2: {
                            return '非户籍';
                        }
                    }
                    return value;
                }
            },
            {field: 'recordFamily', title: '家庭档案', width: 100},
            {field: 'userMyphone', title: '本人电话', width: 100},
            {
                field: 'recordBookbuilding', title: '建档方式', width: 100, formatter: function (value, row, index) {
                    switch (value) {
                        case 3: {
                            return '其他服务';
                        }
                        case 1: {
                            return '诊疗服务';
                        }
                        case 2: {
                            return '公卫服务';
                        }
                    }
                    return value;
                }
            },
        ]]
    });
</script>